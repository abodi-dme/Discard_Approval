@model WebApp_Anti.Models.DiscardApprovalTableViewModel

@functions { public string FormatDateForInput(DateTime? date) => date?.ToString("yyyy-MM-dd") ?? ""; }

@{
    int page = Model.Pager.CurrentPage;
    int pageSize = 50; // keep consistent with controller
    int i = (page - 1) * pageSize;
    var stage = Model.Stage ?? "manager";
    var isFinal = string.Equals(stage, "final", StringComparison.OrdinalIgnoreCase);
    var isApprovedStage = string.Equals(stage, "approved", StringComparison.OrdinalIgnoreCase);
    var isFinalStage = isFinal || isApprovedStage;
    var approvedField = isFinalStage ? "FinalApproved" : "ManagerApproved";
    var approvedDateField = isFinalStage ? "FinalApprovedDate" : "ManagerApprovedDate";
    var role = (ViewBag.UserRole as string) ?? string.Empty;
    var canEditFinal = role == "VP" || role == "Admin";
    var canEditManager = role == "Manager" || role == "VP" || role == "Admin";
    var isReadOnlyStage = isApprovedStage || (isFinalStage && !canEditFinal) || (!isFinalStage && !canEditManager);
}
@foreach (var item in Model.Items)
{
    var approvedValue = isFinalStage ? item.FinalApproved : item.ManagerApproved;
    var approvedDateValue = isFinalStage ? item.FinalApprovedDate : item.ManagerApprovedDate;
    <tr>
        <td>@item.Product</td>
        <td>@item.AssetTag</td>
        <td>@item.Manufacturer</td>
        <td>@item.Model</td>
        <td>@item.ManufacturerSerialNumber</td>
        <td>@item.WarehouseName</td>
        <td>
            <select class="form-select form-select-sm discard-reason-select" name="[@i].DiscardReason" data-notes-target="notes-@stage-@i" @(isReadOnlyStage ? "disabled" : null)>
                <option value="">Select...</option>
                <option value="Sold" selected="@(item.DiscardReason == "Sold" ? "selected" : null)">Sold</option>
                <option value="Scrap" selected="@(item.DiscardReason == "Scrap" ? "selected" : null)">Scrap</option>
                <option value="Lost" selected="@(item.DiscardReason == "Lost" ? "selected" : null)">Lost</option>
                <option value="Other" selected="@(item.DiscardReason == "Other" ? "selected" : null)">Other</option>
            </select>
        </td>
        <td>@item.UnitCost</td>

        <td>
            <input type="hidden" name="[@i].Product" value="@item.Product" />
            <input type="hidden" name="[@i].AssetTag" value="@item.AssetTag" />
            <input type="hidden" name="[@i].UnitCost" value="@item.UnitCost" />
        </td>
        <td></td>
        <td></td>

        <td class="sticky-column sticky-approved">
            <select class="form-select form-select-sm approval-select" data-row-id="@($"{stage}-{i}")" data-date-target="date-@stage-@i" name="[@i].@(approvedField)" @(isReadOnlyStage ? "disabled" : null)>
                <option value="">Select...</option>
                <option value="Yes" selected="@(approvedValue == "Yes" ? "selected" : null)">Yes</option>
                <option value="No" selected="@(approvedValue == "No" ? "selected" : null)">No</option>
            </select>
        </td>

        <td class="sticky-column sticky-date">
            <input type="date" class="form-control form-control-sm approval-date" id="date-@stage-@i"
                   name="[@i].@(approvedDateField)" value="@FormatDateForInput(approvedDateValue)" readonly />
        </td>

        @if (isFinal || isApprovedStage)
        {
            <td class="sticky-column sticky-manager-notes">
                <input type="text" class="form-control form-control-sm notes-input" value="@item.ManagerNotes" readonly />
            </td>
            <td class="sticky-column sticky-notes">
                <input type="text" class="form-control form-control-sm notes-input" id="notes-@stage-@i" name="[@i].FinalNotes"
                       value="@item.FinalNotes" placeholder="Enter final notes..." @(isReadOnlyStage ? "readonly" : null) />
            </td>
        }
        else
        {
            <td class="sticky-column sticky-notes">
                <input type="text" class="form-control form-control-sm notes-input" id="notes-@stage-@i" name="[@i].ManagerNotes"
                       value="@item.ManagerNotes" placeholder="Enter manager notes..." @(isReadOnlyStage ? "readonly" : null) />
            </td>
        }
    </tr>
    i++;
}
