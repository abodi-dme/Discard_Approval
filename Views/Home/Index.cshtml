@model WebApp_Anti.Models.DiscardApprovalPageViewModel

@{
    ViewData["Title"] = "Discard Approval Inputs";
    var hasData = (Model?.ManagerTable?.Items?.Any() ?? false) || (Model?.FinalTable?.Items?.Any() ?? false);
}

@if (hasData)
{
    <header class="approval-header">
        <div class="header-left">
            <img src="~/images/logo.png" alt="Logo" class="app-logo" />
            <div class="header-title">Discard Approval</div>
        </div>
        <div class="header-center">
            <button type="button" class="tab-btn active" data-tab="manager">Manager Approval</button>
            <button type="button" class="tab-btn" data-tab="final">Final Approval</button>
        </div>
        <div class="header-right">
            <button type="submit" form="submitForm-manager" class="btn btn-success btn-lg px-4 submit-btn-fixed" data-stage="manager">
                Submit
            </button>
            <button type="submit" form="submitForm-final" class="btn btn-success btn-lg px-4 submit-btn-fixed d-none" data-stage="final">
                Submit
            </button>
        </div>
    </header>

    <div class="page-content">
        @if (TempData["Message"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                @TempData["Message"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

    <div class="tab-panel active" data-tab="manager">
        <div class="top-scroll-container">
            <div class="top-scroll-content"></div>
        </div>

        <div class="table-responsive" data-stage="manager">
            <form asp-action="Submit" method="post" id="submitForm-manager">
                <input type="hidden" name="stage" value="manager" />
                <div class="table-container" data-stage="manager">
                    @await Html.PartialAsync("_DiscardApprovalTable", Model.ManagerTable)
                </div>
            </form>
        </div>
    </div>

    <div class="tab-panel" data-tab="final">
        <div class="top-scroll-container">
            <div class="top-scroll-content"></div>
        </div>

        <div class="table-responsive" data-stage="final">
            <form asp-action="Submit" method="post" id="submitForm-final">
                <input type="hidden" name="stage" value="final" />
                <div class="table-container" data-stage="final">
                    @await Html.PartialAsync("_DiscardApprovalTable", Model.FinalTable)
                </div>
            </form>
        </div>
    </div>

    </div>
}
else
{
    <div class="alert alert-info">
        No data found or connection failed. (Filtered by 'Needs Repairing')
    </div>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            function getPanel(stage) {
                return document.querySelector('.tab-panel[data-tab="' + stage + '"]');
            }

            function syncTopScrollbar(stage) {
                var panel = getPanel(stage);
                if (!panel) return;

                var tableContainer = $(panel).find(".table-responsive");
                var topScrollContainer = $(panel).find(".top-scroll-container");
                var topScrollContent = $(panel).find(".top-scroll-content");

                if (topScrollContainer.length === 0 || topScrollContent.length === 0) return;

                var tableWidth = $(panel).find(".table").outerWidth() || 0;
                topScrollContent.width(tableWidth);

                topScrollContainer.off("scroll").on("scroll", function () {
                    tableContainer.scrollLeft(topScrollContainer.scrollLeft());
                });

                tableContainer.off("scroll").on("scroll", function () {
                    topScrollContainer.scrollLeft(tableContainer.scrollLeft());
                });
            }

            function wireApprovalDateAutoFill() {
                $(document).off("change", ".approval-select").on("change", ".approval-select", function () {
                    var selectedValue = $(this).val();
                    var dateTarget = $(this).data("date-target");
                    var dateInput = $("#" + dateTarget);

                    if (selectedValue === "Yes") {
                        var today = new Date().toISOString().split("T")[0];
                        dateInput.val(today);
                    } else {
                        dateInput.val("");
                    }
                });
            }

            function getFilters(stage, page) {
                var panel = getPanel(stage);
                if (!panel) return { stage: stage, page: page || 1 };

                return {
                    stage: stage,
                    page: page || 1,
                    filterProduct: $(panel).find('[data-filter="filterProduct"]').val() || "",
                    filterAssetTag: $(panel).find('[data-filter="filterAssetTag"]').val() || "",
                    filterStatus: $(panel).find('[data-filter="filterStatus"]').val() || "",
                    filterManufacturer: $(panel).find('[data-filter="filterManufacturer"]').val() || "",
                    filterModel: $(panel).find('[data-filter="filterModel"]').val() || "",
                    filterSerialNumber: $(panel).find('[data-filter="filterSerialNumber"]').val() || "",
                    filterWarehouse: $(panel).find('[data-filter="filterWarehouse"]').val() || "",
                    filterDiscardReason: $(panel).find('[data-filter="filterDiscardReason"]').val() || ""
                };
            }

            function toQueryString(obj) {
                var p = new URLSearchParams();
                Object.keys(obj).forEach(function (k) {
                    var v = obj[k];
                    if (v !== null && v !== undefined && String(v).trim() !== "") p.set(k, v);
                });
                return p.toString();
            }

            let filterTimer = null;
            let currentFetch = null;

            async function refreshTable(stage, page) {
                if (currentFetch) currentFetch.abort();
                currentFetch = new AbortController();

                const filters = getFilters(stage, page);
                const qs = toQueryString(filters);
                const url = '@Url.Action("TablePartial", "Home")' + (qs ? ("?" + qs) : "");

                let res;
                try {
                    res = await fetch(url, {
                        signal: currentFetch.signal,
                        headers: { "X-Requested-With": "XMLHttpRequest" }
                    });
                } catch (e) {
                    console.error("Fetch failed", e);
                    return;
                }

                if (!res.ok) {
                    console.error("Bad response", res.status);
                    return;
                }

                const html = await res.text();
                const doc = new DOMParser().parseFromString(html, "text/html");

                const newTbody = doc.querySelector("tbody#rowsContainer-" + stage);
                const newPager = doc.querySelector("div#pagerContainer-" + stage);

                if (!newTbody || !newPager) {
                    console.error("AJAX partial missing rows/pager. Returned HTML:", html);
                    return;
                }

                const rowsContainer = document.querySelector("tbody#rowsContainer-" + stage);
                const pagerContainer = document.querySelector("div#pagerContainer-" + stage);

                if (rowsContainer) rowsContainer.replaceWith(newTbody);
                if (pagerContainer) pagerContainer.replaceWith(newPager);

                history.replaceState(null, "", qs ? ("?" + qs) : location.pathname);

                syncTopScrollbar(stage);
                wireApprovalDateAutoFill();
            }

            function activateTab(stage) {
                $(".tab-btn").removeClass("active");
                $('.tab-btn[data-tab="' + stage + '"]').addClass("active");

                $(".tab-panel").removeClass("active");
                $('.tab-panel[data-tab="' + stage + '"]').addClass("active");

                $(".submit-btn-fixed").addClass("d-none");
                $('.submit-btn-fixed[data-stage="' + stage + '"]').removeClass("d-none");

                syncTopScrollbar(stage);
            }

            syncTopScrollbar("manager");
            wireApprovalDateAutoFill();

            $(document).on("change", ".tab-panel [data-filter]", function () {
                var stage = $(this).closest(".tab-panel").data("tab");
                clearTimeout(filterTimer);
                filterTimer = setTimeout(function () { refreshTable(stage, 1); }, 200);
            });

            $(document).on("click", ".clear-filters-btn", function () {
                var stage = $(this).closest(".tab-panel").data("tab");
                var panel = getPanel(stage);
                if (!panel) return;
                $(panel).find('[data-filter]').val("");
                refreshTable(stage, 1);
            });

            $(document).on("click", "a[data-page][data-stage]", function () {
                const page = parseInt($(this).attr("data-page"));
                const stage = $(this).attr("data-stage");
                if (!isNaN(page) && page > 0) refreshTable(stage, page);
            });

            $(document).on("click", ".tab-btn", function () {
                activateTab($(this).data("tab"));
            });
        });
    </script>
}
